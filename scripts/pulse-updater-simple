#!/bin/bash
# Simplified Pulse Update Script - Schedules update via file
# Usage: pulse-updater-simple <version> <download_url>

VERSION="$1"
DOWNLOAD_URL="$2"

if [ -z "$VERSION" ] || [ -z "$DOWNLOAD_URL" ]; then
    echo "Usage: $0 <version> <download_url>"
    exit 1
fi

# Write update job to file for processing
UPDATE_JOB="/tmp/pulse-update-job"
cat > "$UPDATE_JOB" <<EOF
VERSION=$VERSION
DOWNLOAD_URL=$DOWNLOAD_URL
TIMESTAMP=$(date +%s)
EOF

# Create the actual update script that will be run
cat > /tmp/pulse-do-update.sh <<'SCRIPT'
#!/bin/bash
set -e

# Read job file
source /tmp/pulse-update-job
LOG_FILE="/tmp/pulse-updater.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >> "$LOG_FILE"
}

log "Starting update to version $VERSION"

# Wait for parent process to exit
sleep 5

TEMP_DIR="/tmp/pulse-update-$$"
mkdir -p "$TEMP_DIR"
cd "$TEMP_DIR"

# Download
log "Downloading from $DOWNLOAD_URL"
wget -q --timeout=60 "$DOWNLOAD_URL" -O update.tar.gz || exit 1

# Extract
log "Extracting update"
tar -xzf update.tar.gz || exit 1

# Find binary
PULSE_BINARY=""
[ -f "pulse" ] && PULSE_BINARY="pulse"
[ -f "pulse-linux-amd64" ] && PULSE_BINARY="pulse-linux-amd64"

if [ -z "$PULSE_BINARY" ]; then
    log "ERROR: No binary found"
    exit 1
fi

# Stop service
log "Stopping pulse service"
systemctl stop pulse || true

# Install binary
log "Installing new binary"
cp "$PULSE_BINARY" /usr/local/bin/pulse
chmod 755 /usr/local/bin/pulse

# Start service  
log "Starting pulse service"
systemctl start pulse

# Verify
sleep 2
if systemctl is-active --quiet pulse; then
    log "Update completed successfully to version $VERSION"
else
    log "ERROR: Service failed to start"
    exit 1
fi

# Cleanup
rm -rf "$TEMP_DIR"
rm -f /tmp/pulse-update-job
rm -f /tmp/pulse-do-update.sh

exit 0
SCRIPT

chmod +x /tmp/pulse-do-update.sh

# Schedule the update script to run independently
echo "/tmp/pulse-do-update.sh" | at now + 1 minute 2>/dev/null || \
    (nohup /tmp/pulse-do-update.sh </dev/null >/dev/null 2>&1 &)

echo "Update scheduled"
exit 0