#!/bin/bash
# Pulse Update Script - runs with sudo to update root-owned binary
# This script is called by the Pulse auto-update mechanism when running as non-root

set -e

VERSION="$1"
DOWNLOAD_URL="$2"

if [ -z "$VERSION" ] || [ -z "$DOWNLOAD_URL" ]; then
    echo "Usage: $0 <version> <download_url>"
    exit 1
fi

echo "Starting Pulse update to version $VERSION"

# Create temp directory
TEMP_DIR=$(mktemp -d /tmp/pulse-update.XXXXXX)
trap "rm -rf $TEMP_DIR" EXIT

# Download update
echo "Downloading update from $DOWNLOAD_URL"
cd "$TEMP_DIR"
wget -q "$DOWNLOAD_URL" -O pulse-update.tar.gz

# Extract
echo "Extracting update"
tar -xzf pulse-update.tar.gz

# Verify pulse binary exists
if [ ! -f "pulse" ]; then
    echo "Error: pulse binary not found in archive"
    exit 1
fi

# Backup current binary
echo "Creating backup"
cp /usr/local/bin/pulse /usr/local/bin/pulse.backup

# Stop service
echo "Stopping Pulse service"
systemctl stop pulse

# Install new binary
echo "Installing new binary"
cp pulse /usr/local/bin/pulse
chmod 755 /usr/local/bin/pulse

# Start service
echo "Starting Pulse service"
systemctl start pulse

echo "Update completed successfully"